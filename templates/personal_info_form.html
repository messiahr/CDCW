<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Personal Information Form</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
  <script>
    let allRecords = [];

    // Fetch records on load
    async function fetchRecords() {
      try {
        const response = await fetch('/get-records');
        const data = await response.json();
        allRecords = data;
        filterResults();
      } catch (error) {
        console.error('Error fetching records:', error);
      }
    }

    async function printTicket(id, name, skipConfirm = false) {
      if (!skipConfirm && !confirm(`Print ticket for ${name}?`)) return;

      try {
        const response = await fetch('/print', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            text: `Name: ${name}\nID: ${id}`,
            qr_code: id,
            newlines: 5
          })
        });

        const result = await response.json();
        if (result.status === 'success') {
          alert('Ticket printed successfully!');
        } else {
          alert('Error printing ticket: ' + (result.error || 'Unknown error'));
        }
      } catch (error) {
        console.error('Error:', error);
        alert('Failed to send print request');
      }
    }

    function renderResults(records) {
      const container = document.getElementById("results");
      const showDetails = document.getElementById("show_details").checked;

      container.innerHTML = "<h3>Live Matches (" + Math.min(records.length, 10) + " shown)</h3>";

      // Cap at 10 results
      const displayRecords = records.slice(0, 10);

      if (displayRecords.length === 0) {
        container.innerHTML += "<p>No matches found.</p>";
        return;
      }

      displayRecords.forEach(record => {
        // record indices: 0:ID, 1:Name, 2:Age, 3:Gender, 4:Height, 5:Hair Color, 6:Hair Length, 7:Mobility Aid, 8:Features, 9:Add Info
        const div = document.createElement("div");
        div.className = "result-item";
        div.style.display = "flex";
        div.style.justifyContent = "space-between";
        div.style.alignItems = "center";

        let content = `<div style="flex-grow: 1;"><strong>${record[1]}</strong> (${record[2]}, ${record[3]}) - ${record[4]}`;

        if (showDetails) {
          content += `<br>Hair: ${record[5] || '-'}, ${record[6] || '-'} | Mobility: ${record[7] || '-'}`;
          if (record[8]) content += `<br><em>Features:</em> ${record[8]}`;
          if (record[9]) content += `<br><em>Info:</em> ${record[9]}`;
        }
        content += `</div>`;

        const btn = document.createElement("button");
        btn.className = "print-ticket-btn";
        btn.textContent = "Print Ticket";
        btn.onclick = () => printTicket(record[0], record[1]);
        btn.style.marginLeft = "10px";

        div.innerHTML = content;
        div.appendChild(btn);

        container.appendChild(div);
      });
    }

    function filterResults() {
      const nameFilter = document.getElementById("name").value.toLowerCase().trim();
      const dobFilter = document.getElementById("dob").value;
      const genderFilter = document.getElementById("gender").value;
      const heightFilter = document.getElementById("height").value;
      const hairColorFilter = document.getElementById("hair_color").value;
      const hairLengthFilter = document.getElementById("hair_length").value;
      const mobilityAidFilter = document.getElementById("mobility_aid").value;
      // Features filter is removed from logic as requested

      const filtered = allRecords.filter(record => {
        // valid checks if the record field exists and matches the filter
        // New Order: 0:ID, 1:Name, 2:Age, 3:Gender, 4:Height, 5:Hair Color, 6:Hair Length, 7:Mobility Aid, 8:Features, 9:Add Info

        // Name filter (partial match)
        if (nameFilter) {
          const recName = record[1] != null ? String(record[1]).toLowerCase() : "";
          if (!recName.includes(nameFilter)) return false;
        }

        // Age filter (exact match, case-insensitive)
        if (dobFilter) {
          const recAge = record[2] != null ? String(record[2]).toLowerCase() : "";
          if (recAge !== dobFilter) return false;
        }

        // Gender filter (exact match, case-insensitive)
        if (genderFilter) {
          const recGender = record[3] != null ? String(record[3]).toLowerCase() : "";
          // Handle potential differences in terminology if any
          if (recGender !== genderFilter) return false;
        }

        // Height filter (exact match, case-insensitive)
        if (heightFilter) {
          const recHeight = record[4] != null ? String(record[4]).toLowerCase() : "";
          if (recHeight !== heightFilter) return false;
        }

        // Hair Color filter
        if (hairColorFilter) {
          const recHairColor = record[5] != null ? String(record[5]).toLowerCase() : "";
          if (!recHairColor.includes(hairColorFilter)) return false;
        }

        // Hair Length filter
        if (hairLengthFilter) {
          const recHairLength = record[6] != null ? String(record[6]).toLowerCase() : "";
          if (!recHairLength.includes(hairLengthFilter)) return false;
        }

        // Mobility Aid filter
        if (mobilityAidFilter) {
          const recMobility = record[7] != null ? String(record[7]).toLowerCase() : "";
          if (!recMobility.includes(mobilityAidFilter)) return false;
        }

        return true;
      });

      renderResults(filtered);
    }

    // JavaScript to populate height options (gender agnostic)
    function populateHeightOptions() {
      const heightSelect = document.getElementById("height");

      // Clear existing options
      heightSelect.innerHTML = "";

      let options = [];

      // Add default option
      const defaultOption = document.createElement("option");
      defaultOption.value = "";
      defaultOption.text = "Select Height Range";
      defaultOption.disabled = true;
      defaultOption.selected = true;
      heightSelect.appendChild(defaultOption);

      // Define static height ranges
      options = [
        { value: "short", text: "Short" },
        { value: "average", text: "Average" },
        { value: "tall", text: "Tall" }
      ];

      // Append new options
      options.forEach(option => {
        const optElement = document.createElement("option");
        optElement.value = option.value;
        optElement.textContent = option.text;
        heightSelect.appendChild(optElement);
      });
    }
  </script>
</head>

<body>
  <div class="form-container">
    <h1>Personal Information Form</h1>
    <form action="/submit" method="post">
      <label for="name">Name:</label>
      <input type="text" id="name" name="name" required oninput="filterResults()">

      <label for="dob">Age Range:</label>
      <select id="dob" name="dob" required onchange="filterResults()">
        <option value="" selected disabled>Select Age Range</option>
        <option value="teen">Teen</option>
        <option value="young">Young Adult</option>
        <option value="older">Older Adult</option>
        <option value="senior">Senior</option>
      </select>

      <label for="gender">Gender:</label>
      <select id="gender" name="gender" required onchange="filterResults()">
        <option value="" selected disabled>Select Gender</option>
        <option value="male">Male</option>
        <option value="female">Female</option>
        <option value="other">Other</option>
      </select>

      <label for="height">Height Range:</label>
      <select id="height" name="height" required onchange="filterResults()">
        <!-- Height options will be dynamically added based on gender -->
      </select>

      <label for="hair_color">Hair Color:</label>
      <select id="hair_color" name="hair_color" onchange="filterResults()">
        <option value="" selected disabled>Select Hair Color</option>
        <option value="dark">Dark</option>
        <option value="light">Light</option>
        <option value="other">Other</option>
      </select>

      <label for="hair_length">Hair Length:</label>
      <select id="hair_length" name="hair_length" onchange="filterResults()">
        <option value="" selected disabled>Select Hair Length</option>
        <option value="bald">Bald</option>
        <option value="short">Short</option>
        <option value="long">Long</option>
        <option value="covered">Covered</option>
      </select>

      <label for="mobility_aid">Mobility Aid:</label>
      <select id="mobility_aid" name="mobility_aid" onchange="filterResults()">
        <option value="" selected disabled>Select Mobility Aid</option>
        <option value="none">None</option>
        <option value="cane">Cane</option>
        <option value="walker">Walker</option>
        <option value="wheelchair">Wheelchair</option>
        <option value="service animal">Service Animal</option>
      </select>

      <label for="features">Distinguishing Features:</label>
      <textarea id="features" name="features" rows="4" cols="50"></textarea>

      <label for="additional_info">Additional Information:</label>
      <textarea id="additional_info" name="additional_info" rows="4" cols="50"></textarea>

      <button type="submit">Submit & Generate New Ticket</button>
    </form>

    <div style="margin-top: 20px;">
      <label>
        <input type="checkbox" id="show_details" onchange="filterResults()">
        Show Distinguishing Features & Additional Info
      </label>
    </div>

    <div id="results" class="results-container"></div>
  </div>

  <script>
    // Initialize the height options on page load and fetch records
    window.onload = function () {
      populateHeightOptions();
      fetchRecords();

      document.querySelector('form').addEventListener('submit', async function (e) {
        e.preventDefault();
        const formData = new FormData(this);

        try {
          const response = await fetch('/submit', {
            method: 'POST',
            body: formData
          });
          const result = await response.json();

          if (result.status === 'success') {
            this.reset();
            fetchRecords();
            await printTicket(result.id, result.name, true);
          } else {
            alert('Error submitting: ' + (result.message || 'Unknown error'));
          }
        } catch (error) {
          console.error('Error:', error);
          alert('Failed to submit form');
        }
      });
    };
  </script>
</body>

</html>